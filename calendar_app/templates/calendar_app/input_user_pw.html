{% extends 'base.html' %}
{% load filters %}
{% load static %}

<!-- css -->
{% block style %}
<link rel="stylesheet" href="{% static 'calendar_app/css/main.css' %}?after">
{% endblock style %}

<!-- title -->
{% block title %}List up{% endblock %}

{% block container %}
<div class="rs-tabs" id="anchor2">
  <div class="tabs">
    <ul>
      <li><a href="{% url 'Idx_list' %}#reserve_pg">업체예약</a></li>
    </ul>
    <ul class="active">
      <li><a href="{% url 'find_reservation' %}#anchor1">예약조회</a></li>
    </ul>
    <ul>
      <li><a href="">상세정보</a></li>
    </ul>
    <ul>
      <li><a href="">tab</a></li>
    </ul>
    <ul>
      <li><a href="">tab</a></li>
    </ul>
    <ul>
      <li><a href="">tab</a></li>
    </ul>
  </div>
</div>
{% if delete_rsv %}
  <div>
    <title>예약 삭제 완료</title>
    <div>예약이 삭제되었습니다.</div>
    <a href="{% url 'find_reservation' %}#anchor1">다른 예약 조회하기</a>
  </div>

{% elif not form_submitted %}
  <div>
    <form method="post" action="{% url 'input_user_pw' %}" class="passwordForm">
        {% csrf_token %}
        <label for="input_pw">비밀번호를 입력하세요: (네자리 숫자)</label>
        <input type="password" id="input_pw" name="input_pw" required placeholder="0000" pattern="[0-9]+" maxlength='4'>
        <input type="submit" value="Submit" name="form1">
    </form>
  </div>

{% elif form_submitted %}
<!-- detail 합치기 -->
  <div>
    {% if not pw_checked %}
    <div>
      <form method="post" action="{% url 'input_user_pw' %}" class="passwordForm">
          {% csrf_token %}
          <label for="input_pw">비밀번호를 입력하세요: (네자리 숫자)</label>
          <input type="password" id="input_pw" name="input_pw" required placeholder="0000" pattern="[0-9]+" maxlength='4'>
          <input type="submit" value="Submit" name="form1">
      </form>
    </div>

    <script>
    // 페이지 로딩후 fetchData 실행
    window.onload = function() {
        fetchData();
      };

      var hasWaiting;

      // has_waiting_time 값에서 null값을 false로 바꾸기위함
      function yesno(value) {
        if (value === null) return false;
        return value;
      }


      // 비동기 수정
      async function fetchData() {
            const response = await fetch("pass/");  
            // console.log("response", response);
            let jsongogo = await response.json();
            // console.log("jsongogo", jsongogo);
            hasWaiting = yesno(jsongogo.has_waiting_time);
            console.log(hasWaiting);
            console.log("제이슨", jsongogo);

            var retryLogin = jsongogo.retry_login;
            var blockCount = jsongogo.block_count;
            var warning = jsongogo.warning;  // 서버에서 받은 메시지
            var addRemainTime = ""; // 미리 선언
            console.log("워닝", warning);

            // blockCount와 retryLogin 값을 체크하여 폼 제출을 막는 로직
            var passwordForms = document.getElementsByClassName('passwordForm');
            console.log("passwordForms", passwordForms)
            // 조건이 잘못되서 그런가..?
            console.log("blockCount", blockCount)
            console.log("retryLogin", retryLogin)

            // 재시도횟수 초과시 폼 전송x
            for (var i = 0; i < passwordForms.length; i++) {
                passwordForms[i].addEventListener('submit', function(e) {
                    if (blockCount >= 3 && retryLogin === 0) {
                        e.preventDefault();
                        alert("비밀번호 재시도 횟수를 초과하여 잠금되었습니다. 업체에 문의해주세요.");
                    }
                });
            }
            // 수정수정
            if (warning) {
              var addmsg = warning + "\n\n재시도 횟수: " + retryLogin + "회\n\n";

              console.log("hasWaiting", hasWaiting);
              console.log("jsongogo.has_waiting_time", jsongogo.has_waiting_time);
              if (hasWaiting === true) {
                console.log("retryLogin", retryLogin);
                console.log("blockCount", blockCount);
                // 남은 대기시간 출력
                if (retryLogin === 0 && blockCount <= 3) {
                  remainingTime = jsongogo.remaining_time_in_seconds;
                  console.log("남은시간이당", remainingTime)
                  var countDownDate = new Date().getTime() + remainingTime * 1000;  // 서버에서 받은 남은 시간(초)을 밀리초로 변환
                  console.log("countDownDate", countDownDate)

                  var now = new Date().getTime();
                  console.log("now", now)
                  var distance = countDownDate - now;
                  console.log("distance", distance)

                  var minutes = Math.floor(distance / (1000 * 60));
                  var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                  console.log("minutes", minutes)
                  console.log("seconds", seconds)

                  addRemainTime ="남은 대기시간: "+ minutes + "분 " + seconds + "초 ";
                  addmsg += addRemainTime;

                  console.log("addRemainTime", addRemainTime)

                }
                alert(addmsg);
              }
              else{
                alert(warning);
              }
            }
          }



    </script>
    {% elif pw_checked and block_account %}
    <div> {{ warning }}</div>



    {% else %}
    <div>이름: {{ booking.user_name }}</div>
    <div>전화번호: {{ booking.user_phone }}</div>
    <br>
    <div>예약 매장명: {{ booking.store_id.store_name }}</div>
    <div>예약 날짜: {{ booking.reservation_date }}</div>
    <div>예약 시간: {{ booking.user_time }}</div>
    <div>예약 인원: {{ booking.visitor_num }}</div>
    
    <form method="post" id="delete-form">
        {% csrf_token %}
        <input type="submit" value="예약취소" name="form2" id="delete-btn">
    </form>


  </div>
  
  <script>
    let deleteButton = document.querySelector('#delete-btn');
    let deleteForm = document.querySelector('#delete-form');

    deleteForm.addEventListener('submit', function(e) {
      var result = confirm('정말로 삭제하시겠습니까?');
      
      if (!result) {
        // 사용자가 'Cancel'을 클릭한 경우, 폼 전송을 취소합니다.
        e.preventDefault();
      }
    });
  </script>
  <!-- detail 합치기 끝 -->


  {% endif %}
{% endif %}

{% if invalid_access %}
<script>
alert("잘못된 접근입니다.");
window.location.href = "{% url 'find_reservation' %}#anchor1";
</script>
{% endif %}



<!-- 리다이렉션 후 스크롤되게 -->
<!-- {% if anchor2 %}
<script>
window.onload = function() {
    location.hash = "#{{ anchor2 }}";
    document.getElementById('input_pw').value = '';
};
</script>
{% endif %} -->

  
{% endblock %}