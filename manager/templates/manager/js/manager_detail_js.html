{% include "manager/test/reconnecting-websocket.html" %}

<script>
  let userName = "{{ username|escapejs }}";
  // console.log(userName);
  const loc = window.location;
  // console.log(loc);
  // const loc = "127.0.0.1:8000/manager/";
  const loc2 = "/manager/admin_chat2/";
  // const loc3 = 
  let weStart = "ws://";
  if (loc.protocol === "https:") {
    weStart = "wss://"
  }
  let manager_detail_webSockets = {}

  async function accessAllChannels() {

    let endpoints = [
      { name: "chat", url: weStart + loc.host + loc2 + userName + "/" },
      { name: "manager_detail", url: weStart + loc.host + loc.pathname + userName + "/" },
    ];
    Notification.requestPermission().then(function (permission) {
      console.log('Permission:', permission);
    });

    for (let ept of endpoints) {
      // if (manager_webSockets[chat]) {
      //   continue;
      // }
      let webSocket = new ReconnectingWebSocket(ept.url);
      manager_detail_webSockets[ept.name] = webSocket;
      // console.log(ept.name);

      webSocket.onopen = function (e) {
        console.log(webSocket.url);
        console.log('Web socket opened successfully');
      };
      // webSocket.onmessage = function(e){
      //   console.log(ept.name);
      //   handleOnMessage(webSocket,e);

      // };
      webSocket.onmessage = function (e) {
        data = JSON.parse(e.data);
        console.log(data);
      }
      // webSocket.addEventListener("message", function (e) {
      //   handleOnMessage(webSocket, e);
      // });
      webSocket.onclose = function (e) {
        console.error('Socket closed unexpectedly');
      };
    }

  }
  accessAllChannels();
  // console.table("콘솔태이블", manager_detail_webSockets);
  let detailSocket = manager_detail_webSockets["manager_detail"];

  // function selectedDate(){
  //   if (detailSocket.readyState === WebSocket.OPEN){
  //     detailSocket.send(JSON.stringify({
  //       "command" : "selected_date",
  //       "select_date" : selected_date.value,
  //     }));
  //   }
  // }
  // selectedDate();
  
</script>