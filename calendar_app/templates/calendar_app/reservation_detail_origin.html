{% extends 'base.html' %}
{% load filters %}
{% load static %}

<!-- css -->
{% block style %}
<link rel="stylesheet" href="{% static 'calendar_app/css/main.css' %}?after">
{% endblock style %}

<!-- title -->
{% block title %}List up{% endblock %}

{% block container %}
<div class="rs-tabs" id="anchor3">
    <div class="tabs">
      <ul>
        <li><a href="{% url 'Idx_list' %}#reserve_pg">업체예약</a></li>
      </ul>
      <ul class="active">
        <li><a href="{% url 'find_reservation' %}#anchor1">예약조회</a></li>
      </ul>
      <ul>
        <li><a href="">상세정보</a></li>
      </ul>
      <ul>
        <li><a href="">tab</a></li>
      </ul>
      <ul>
        <li><a href="">tab</a></li>
      </ul>
      <ul>
        <li><a href="">tab</a></li>
      </ul>
    </div>
</div>

<div>
  {% if warning %}
  <button>뒤로가기</button>
  <div id="retry_login"></div>
  <p id="timer"></p>
  <!-- <div class="messages">
    <div class="warning">{{ warning }}</div>
  </div> -->

  <script>

  

  // document.getElementById("retry_login").innerText = "재시도 횟수: {{ retry_login }}회";  // 서버에서 받은 재시도 횟수

  // 수정전
  var retryLogin = {{ retry_login }};  // 서버에서 받은 재시도 횟수
  var blockCount = {{ block_count }};  // 서버에서 받은 block_count
  var hasWaiting = {{ has_waiting_time|yesno:"true,false" }}; // 서버에서 받은 대기시간 존재여부

  // console.log(hasWaiting);

  // var warning = "{{ warning }}";  // 서버에서 받은 메시지
  // if (warning) {
  //   // alert(warning);
  //   if (hasWaiting === true) {
  //       var addmsg = "재시도 횟수: " + retryLogin + "회";
  //       alert(warning + addmsg);
  //       console.log(addmsg);
  //       // alert(warning + addmsg);
  //   } else {
  //       alert(warning);
  //       console.log(addmsg);
  //   }
  // }
  // console.log(addmsg);


  window.onload = function() {
    fetchData();
  };

  var hasWaiting;

  // has_waiting_time 값에서 null값을 false로 바꾸기위함
  function yesno(value) {
    if (value === null) return false;
    return value;
  }


  async function fetchData() {
        //     // fetch('/detail_view/')
        //     fetch('http://127.0.0.1:8000/detail_view/')
        //         .then(response => {
        //             if (!response.ok) {
        //                 throw new Error("HTTP error " + response.status);
        //             }
        //             return response.json();
        //         })
        //         .then(data => {
        //             console.log(data.has_waiting_time);

        //             var retryLogin = data.retry_login;  // 서버에서 받은 재시도 횟수
        //             var blockCount = data.block_count;  // 서버에서 받은 block_count
        //             var hasWaiting = data.has_waiting_time; // 서버에서 받은 대기시간 존재여부
        //             var warning = data.warning;  // 서버에서 받은 메시지
                    
        //             console.log(hasWaiting);

        //             if (warning) {
        //                 if (hasWaiting === true) {
        //                     var addmsg = "재시도 횟수: " + retryLogin + "회";
        //                     alert(warning + addmsg);
        //                     console.log(addmsg);
        //                 } else {
        //                     alert(warning);
        //                     console.log(addmsg);
        //                 }
        //             }
        //             console.log(addmsg);

        //         })
        //         .catch(function(error) {
        //             console.log("Fetch error occurred: ", error);
        //         });

        const response = await fetch("pass/");  
        const jsongogo = await response.json();
        hasWaiting = yesno(jsongogo.has_waiting_time);
        console.log(hasWaiting);
        }
        // fetchData();

  // document.getElementById("retry_login").innerText = "재시도 횟수: " + retryLogin + "회";

  // console.log('retryLogin:', retryLogin)
  // console.log('blockCount:', blockCount)
  // if (retryLogin === 0 && blockCount <= 3) {
  //     var countDownDate = new Date().getTime() + {{ remaining_time_in_seconds }} * 1000;  // 서버에서 받은 남은 시간(초)을 밀리초로 변환

  //     var countdownFunction = setInterval(function() {
  //         var now = new Date().getTime();
  //         var distance = countDownDate - now;

  //         var minutes = Math.floor(distance / (1000 * 60));
  //         var seconds = Math.floor((distance % (1000 * 60)) / 1000);

  //         document.getElementById("timer").innerHTML = minutes + "분 " + seconds + "초 ";

  //         if (distance < 0) {
  //             clearInterval(countdownFunction);
  //             document.getElementById("timer").innerHTML = "0분 0초";
  //         }
  //     }, 1000);
  // }
  
  </script>


  {% else %}
  
  <div>이름: {{ reservation.user_name }}</div>
  <div>전화번호: {{ reservation.user_phone }}</div>
  <br>
  <div>예약 매장명: {{ reservation.store_id.store_name }}</div>
  <div>예약 날짜: {{ reservation.reservation_date }}</div>
  <div>예약 시간: {{ reservation.user_time }}</div>
  <div>예약 인원: {{ reservation.visitor_num }}</div>
  
  <form method="post">
      {% csrf_token %}
      <input type="submit" value="예약취소">
  </form>
  
  {% endif %}
</div>




<!-- 리다이렉션 후 스크롤되게 -->
<!-- {% if anchor3 %}
<script>
  window.onload = function () {
    location.hash = "#{{ anchor3 }}";
  };
</script>
{% endif %} -->

{% if invalid_access %}
<script>
alert("잘못된 접근입니다.");
window.location.href = "{% url 'find_reservation' %}#anchor1";
</script>
{% endif %}


<script>
document.addEventListener('DOMContentLoaded', (event) => {
  if(performance.navigation.type == 1){
    // alert("비밀번호를 다시 입력해주세요.");
    location.href = "{% url 'input_user_pw' %}";
    // location.href = "{% url 'input_user_pw' %}#anchor2";
  }
});
</script>

{% endblock %}