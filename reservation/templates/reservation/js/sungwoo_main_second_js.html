<script>
  document.addEventListener('DOMContentLoaded', function () {
    // restoreSelectedDate();
  });
  restoreSelectedDate2();
  setUserDateValue();

  let timeItems = document.querySelectorAll('[class^="time-item-"]');
  let nextButton = document.getElementById('next-button');
  let reservationButton = document.querySelector(".booking");
  // console.log(reservationButton);
  


  // 업체목록의 업체를 클릭하면, 
  function storeTable() {

    document.querySelectorAll(".store-table").forEach(function (storeTable) {
      storeTable.addEventListener('click', async function () {
        // await buildCalendar();
        // console.log("몇 번 실행되냐");
        
        const storeName = storeTable.querySelector('.st-name');
        const storeId = storeTable.querySelector('.st-id');
        const storeCRM = storeId.dataset.crm;
        if (calendar_id === storeCRM){
          return;
        }
        // await calendarHandle(storeCRM);
        // console.log("씨알엠",storeCRM)
        const selectedStore = document.getElementById('selected-store')
        selectedStore.textContent = storeName.innerText;
        selectedStore.dataset.crm = storeTable.dataset.crm;
        // document.getElementById('selected_store').innerText = storeId.innerText;
        // 선택한 업체의 id를 정수로 변환
        const storeIdNumber = parseInt(storeCRM, 10);
        // console.log(storeIdNumber);
        document.getElementById('selected_store2').value = storeIdNumber;

        document.querySelectorAll('.store-table').forEach(function (others) {
          if (others !== storeTable) {
            others.classList.remove('selected');

            // otherItem 확인 및 제거
            others.querySelectorAll('[class^="time-item-"]').forEach(function (otherItem) {
              otherItem.classList.remove('green');
            });
          }
        });

        storeTable.classList.add('selected');
        updateNextButton();
        await calendarHandle(storeCRM);
        // location.reload();
      });
    });
  }

  storeTable();

  let prev_next_button_data = {};
  

  prevCalendar_button.addEventListener('click', async function () {
    prevCalendar(calendar_id, prev_next_button_data[calendar_id][0], prev_next_button_data[calendar_id][1]);
  });

  // '다음 달력' 버튼에 클릭 이벤트 리스너 추가
  nextCalendar_button.addEventListener('click', async function () {
    nextCalendar(calendar_id, prev_next_button_data[calendar_id][0], prev_next_button_data[calendar_id][1]);
  });

  async function calendarHandle(storeId) {
    let table_click = await fetch(`api/store_calendar/${storeId}`);
    let data = await table_click.json();
    let start_date = data.start_rsv_possible;
    let end_date = data.end_rsv_possible;
    prev_next_button_data[storeId] = [start_date, end_date];
    // console.log(prev_next_button_data);
    
    await buildCalendar(storeId, start_date, end_date);
    // console.log(data);
    // console.log(nowMonth);
  }


  function updateNextButton() {
    // console.log("updateNextButton 실행되냐");
    let hasGreen = Array.from(timeItems).some(
      (item) => item.classList.contains('green')
    );


    if (hasGreen) {
      nextButton.style.display = 'block';
    } else {
      nextButton.style.display = 'none';
    }
  }

  // 시간 선택하면 기존에 선택됐던것은 선택해제 후, 선택한 시간을 예약자 정보에 할당
  timeItems.forEach(function (item) {
    item.addEventListener('click', function () {
      const selectedTime = this.getAttribute('data-time');
      document.getElementById('detail_user_time').value = selectedTime;
      timeItems.forEach(function (otherItem) {
        if (otherItem.closest('.store-table.selected') !== null) {
          if (otherItem !== item) {
            otherItem.classList.remove('green');
          }
        }
      });

      item.classList.toggle('green');
      const grandParentData = this.parentNode.parentNode.dataset.crm;
      const channel_name = document.querySelector("#channel_name");
      // const grandParentData = this.parentElement.parentElement.dataset;
      // console.log(grandParentData);
      nextButton.dataset.crm = grandParentData;
      // reservationButton.dataset.crm = grandParentData;
      // channel_name.value = grandParentData
      updateNextButton();
    });
  });

  updateNextButton();

  let selectedDateElement = document.getElementById("selectedDate");
  let sDate = selectedDateElement.textContent;
  let selectedIdElement = document.getElementById("selected_store");
  let sId = selectedIdElement.value;
  // console.log("selectedDateElement", selectedDateElement);
  // console.log('sDate:', sDate);
  // console.log('sId:', selectedIdElement);
  // console.log('sId:', sId);



  // function activateDate(){

  // }
  // console.log(storeData)
  function findStoreDates(storeId) {
    let companyDates = [];

    for (let i = 0; i < storeData.length; i++) {
      if (storeData[i].store_id === storeId) {
        companyDates = JSON.parse(storeData[i].store_dates_json);
        break;
      }
    }

    return companyDates;
  }

  function updateDisabledTimes(storeId, selectedDate) {
    // console.log("updateDisabledTimes 실행되냐");
    // console.log("selectedDate", selectedDate);
    let companyDates = findStoreDates(storeId);
    // console.log("companyDates", companyDates);

    let disableTimes = [];

    for (let i = 0; i < companyDates.length; i++) {
      if (companyDates[i].user_date && companyDates[i].user_date.includes(selectedDate)) {
        disableTimes = disableTimes.concat(JSON.parse(companyDates[i].disable_time));
      }
    }
    // console.log("disableTimes", disableTimes);
    // Remove duplicates from disableTimes
    disableTimes = [...new Set(disableTimes)];

    // Select the time buttons using the storeId and selectedDate
    const timeButtons = document.querySelectorAll(`.time-item-${storeId}, .time-item-${selectedDate}`);

    // Loop through timeButtons and disable or enable them based on disableTimes
    for (let i = 0; i < timeButtons.length; i++) {
      const buttonTime = timeButtons[i].getAttribute("data-time");
      if (disableTimes.includes(buttonTime)) {
        timeButtons[i].disabled = true;
        // 비활성버튼 css스타일 주기
        timeButtons[i].classList.add('disabled-time');
        // console.log("가나다");
      } else {
        timeButtons[i].disabled = false;
        timeButtons[i].classList.remove('disabled-time');
      }
    }


  }

  // updateDisabledTimes(3, selectedDate);
  function getAllStoreIds(storeData) {
    let storeIds = [];

    for (let i = 0; i < storeData.length; i++) {
      const storeId = storeData[i].store_id;
      storeIds.push(storeId);
    }

    return storeIds;
  }

  // 상점 ID 목록 가져오기
  const allStoreIds = getAllStoreIds(storeData);
  // console.log(allStoreIds);
  // 각 상점 ID에 대해 updateDisabledTimes() 함수 호출하기
  // for (let i = 0; i < allStoreIds.length; i++) {
  //   const storeId = allStoreIds[i];
  //   updateDisabledTimes(storeId, sDate);
  //   // console.log(updateDisabledTimes(storeId, sDate)[1]);
  // }



  // 날짜 선택안하면 alert 띄우기
  function checkSelectedDate() {
    const selectedDate = document.getElementsByClassName("choiceDay");
    if (selectedDate.length === 0) {
      alert("날짜를 선택해주세요.");
    } else {
      // 날짜 선택하면 처리
    }
  }



  //  다음버튼 클릭시, 달력 -> 예약탭 전환
  const dateDisplay = document.getElementById('date-display');
  const infoDisplay = document.getElementById('info-display');
  const backClick = document.getElementById('back-btn');

  function toggleTabs() {
    if (infoDisplay.style.display === 'none') {
      dateDisplay.style.transition = 'opacity 500ms ease';
      dateDisplay.style.opacity = '0';

      setTimeout(() => {
        dateDisplay.style.display = 'none';

        infoDisplay.style.transition = 'opacity 500ms ease';
        infoDisplay.style.opacity = '0';
        infoDisplay.style.width = '60%';
        infoDisplay.style.display = 'block';

        setTimeout(() => {
          infoDisplay.style.opacity = '1';
        }, 100);
      }, 200);
    }
  }

  // 뒤로버튼 클릭시, 예약탭 -> 달력 전환
  backClick.addEventListener('click', function () {
    setTimeout(() => {
      infoDisplay.style.display = 'none';

      dateDisplay.style.transition = 'opacity 500ms ease';
      dateDisplay.style.opacity = '0';
      dateDisplay.style.display = 'block';

      setTimeout(() => {
        dateDisplay.style.opacity = '1';
      }, 100);
    }, 200);
  });


  // 모달
  const checkInputs = document.querySelectorAll(".check-input");
  const modal = document.querySelector("#modal");
  const book = document.querySelector(".booking");
  const closeModal = document.getElementsByClassName("close")[0];

  // 모달 띄우기전, input에 값 들어갔나 확인
  function areAllInputsFilled(inputs) {
    return Array.from(inputs).every((input) => input.value.trim() !== "");
  }

  // 버튼 클릭시 모달 띄우기
  book.onclick = function () {
    if (areAllInputsFilled(checkInputs)) {
      modal.style.display = "block";
    } else {
      // 모든 input 값이 채워지지 않은 경우 처리
      alert("모든 입력란을 작성해주세요.");
    }
  };

  // X버튼으로 모달 닫기
  closeModal.onclick = function () {
    modal.style.display = "none";
  };


  // 예약시 전화번호 입력칸에 자동 대쉬
  document.querySelector('#detail_user_phone').addEventListener('keyup', function () {
    this.value = this.value
      .match(/\d*/g).join('')
      .match(/(\d{0,3})(\d{0,4})(\d{0,4})/).slice(1).join('-')
      .replace(/-*$/g, '');
  });

</script>